apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: appgraphs.deception.k8s.io
spec:
  group: deception.k8s.io
  names:
    kind: AppGraph
    listKind: AppGraphList
    plural: appgraphs
    singular: appgraph
    shortNames:
    - ag
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              services:
                type: array
                description: List of services to protect with decoys
                items:
                  type: string
                minItems: 1
              decoyCount:
                type: integer
                description: Number of decoy instances (fixed at 3)
                default: 3
                enum:
                - 3
              autoCleanupMinutes:
                type: integer
                description: Minutes before automatic cleanup
                default: 15
                minimum: 1
                maximum: 60
              sourceIP:
                type: string
                description: Attacker IP address to redirect
              attackType:
                type: string
                description: Type of attack detected
                enum:
                - sql_injection
                - path_traversal
                - rate_limit_exceeded
                - auth_failure_brute_force
              severity:
                type: string
                description: Attack severity level
                enum:
                - critical
                - high
                - medium
                - low
            required:
            - services
            - sourceIP
            - attackType
          status:
            type: object
            properties:
              phase:
                type: string
                description: Current phase of AppGraph
                enum:
                - Pending
                - Creating
                - Active
                - Cleanup
                - Failed
              decoyPods:
                type: array
                description: List of created decoy pod names
                items:
                  type: string
              decoyURLs:
                type: array
                description: URLs of deployed decoys
                items:
                  type: string
              createdAt:
                type: string
                format: date-time
                description: Creation timestamp
              cleanupScheduledAt:
                type: string
                format: date-time
                description: Scheduled cleanup time
              message:
                type: string
                description: Status message
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: SourceIP
      type: string
      jsonPath: .spec.sourceIP
    - name: AttackType
      type: string
      jsonPath: .spec.attackType
    - name: Phase
      type: string
      jsonPath: .status.phase
    - name: Decoys
      type: integer
      jsonPath: .status.decoyPods
      priority: 1
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp

